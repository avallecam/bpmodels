---
output: github_document
bibliography: vignettes/references.bib
link-citations: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# _bpmodels_: Methods for analysing the size and length of chains from branching process models

<!-- badges: start -->
![CRAN/METACRAN](https://img.shields.io/cran/v/bpmodels)
![GitHub R package version](https://img.shields.io/github/r-package/v/epiverse-trace/bpmodels)
![GitHub all releases](https://img.shields.io/github/downloads/epiverse-trace/bpmodels/total?style=flat)
![GitHub issues](https://img.shields.io/github/issues/epiverse-trace/bpmodels)
[![R-CMD-check](https://github.com/epiverse-trace/bpmodels/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/epiverse-trace/bpmodels/actions/workflows/R-CMD-check.yaml)
[![codecov](https://codecov.io/github/epiverse-trace/bpmodels/branch/main/graphs/badge.svg)](https://codecov.io/github/epiverse-trace/bpmodels) 
![GitHub contributors](https://img.shields.io/github/contributors/epiverse-trace/bpmodels)
![GitHub commit activity](https://img.shields.io/github/commit-activity/m/epiverse-trace/bpmodels)
![GitHub](https://img.shields.io/github/license/epiverse-trace/bpmodels)
<!-- badges: end -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

`bpmodels` is an R package to simulate and analyse the size and length of 
branching processes with a given offspring distribution.

# Installation

The latest development version of the `bpmodels` package can be installed via

```{r include=TRUE,eval=FALSE}
devtools::install_github('epiverse-trace/bpmodels')
```

To load the package, use

```{r eval=TRUE}
library('bpmodels')
```

# Quick start

At the heart of the package are the `chain_ll()` and `chain_sim()` functions. 

## Calculating log-likelihoods

The `chain_ll()` function calculates the log-likelihood of a distribution of 
chain sizes or lengths given an offspring distribution and its associated 
parameters. 

For example, if we have observed a distribution of chains of sizes $1, 1, 4, 7$, we can 
calculate the log-likelihood of this observed chain by assuming the offspring 
per generation is Poisson distributed with a mean number (which can be interpreted as the reproduction number $R$) of $0.5$. 

To do this, we run 

```{r}
set.seed(13)
chain_sizes <- c(1, 1, 4, 7) # example of observed chain sizes
chain_ll(x = chain_sizes, offspring = "pois", stat = "size", lambda = 0.5)
```

The first argument of `chain_ll()` is the size (or length) distribution to 
analyse. The second argument, `offspring`, specifies the offspring 
distribution. This is given as a function used to generate random offspring. 
It can be any probability distribution implemented in `R`, that is, one that 
has a corresponding function for generating random numbers beginning with the 
letter `r`. In the case of the example above, since random Poisson numbers are 
generated in `R` using a function called `rpois()`, the string to pass to the 
`offspring` argument is `"pois"`.

The third argument, `stat`, determines whether to analyse chain sizes 
(`"size"`, the default if this argument is not specified) or lengths 
(`"length"`). Lastly, any named arguments not recognised by `chain_ll()` 
are interpreted as parameters of the corresponding probability distribution, 
here `lambda = 0.5` as the mean of the Poisson distribution (see the `R` help 
page for the [Poisson distribution](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/Poisson.html) for more information). 

# Imperfect observations

By default, `chain_ll` assumes perfect observation, where `obs_prob = 1` 
(See `?chain_ll`). If observations are imperfect, the `chain_ll()` function has 
an `obs_prob` argument that can be used to determine the likelihood. In that 
case, true chain sizes or lengths are simulated repeatedly (the number of times 
given by the `nsim_obs` argument), and the likelihood calculated for each of 
these simulations. 

For example, if the probability of observing each case is $0.30$, we use

```{r}
chain_sizes <- c(1, 1, 4, 7) # example of observed chain sizes
ll <- chain_ll(chain_sizes, "pois", "size", obs_prob = 0.3, lambda = 0.5, 
               nsim_obs = 10)
summary(ll)
```

This returns `10` likelihood values (because `nsim_obs = 10`), which can be 
averaged to come up with an overall likelihood estimate.

To find out about usage of the `chain_ll()` function, you can use the `R` help 
file

```{r eval=FALSE}
?chain_ll
```

## Simulating branching processes

To simulate a branching process, we use the `chain_sim()` function. This 
function follows the same syntax as `chain_ll()`.

Below, we are simulating $5$ chains, assuming the offspring are generated using
a Poisson distribution with mean, `lambda = 0.5`. By default, `chain_sim()` 
returns a vector of chain sizes/lengths. However, to override that so that 
a tree of infectees and infectors is returned, we need to specify a function 
for the serial interval and set `tree = TRUE`.

```{r}
chain_sim(n = 5, offspring = "pois", stat = "size", lambda = 0.5)
```

### Simulating trees

To simulate a tree of branching processes, we specify the serial interval 
generation function and set `tree = TRUE` as follows:

```{r}
set.seed(13)

serial_interval <- function(n){rlnorm(n, meanlog = 0.58, sdlog = 1.58)}

chains_df <- chain_sim(n = 5, offspring = 'pois', lambda = 0.5, stat = 'length', 
                       infinite = 100, serial = serial_interval, tree = TRUE)

head(chains_df)
```


# Methodology

If the probability distribution of chain sizes or lengths has an analytical 
solution, this will be used (size distribution: Poisson and negative binomial; 
length distribution: Poisson and geometric). 

If an analytical solution does not exist, simulations are used to approximate 
this probability distributions (using a linear approximation to the cumulative 
distribution for unobserved sizes/lengths). The argument `nsim_offspring` is 
used to specify the number of simulations to be used for this approximation. 

For example, to get offspring drawn from a binomial distribution with 
probability `prob = 0.5`, we run

```{r}
chain_ll(chain_sizes, "binom", "size", size = 1, prob = 0.5, nsim_offspring = 100)
```

## Package vignettes

Specific use cases of _bpmodels_ can be found in 
the [online documentation as package vignettes](https://epiverse-trace.github.io/bpmodels/), under "Articles".

## Reporting bugs 

To report a bug please open an [issue](https://github.com/epiverse-trace/bpmodels/issues/new/choose).

## Contribute

We welcome contributions to enhance the package's functionalities. If you 
wish to do so, please follow the [package contributing guide](https://github.com/epiverse-trace/.github/blob/main/CONTRIBUTING.md).

## Code of conduct

Please note that the _bpmodels_ project is released with a [Contributor Code of Conduct](https://github.com/epiverse-trace/.github/blob/main/CODE_OF_CONDUCT.md). 
By contributing to this project, you agree to abide by its terms.

## Citing this package

```{r message=FALSE, warning=FALSE}
citation("bpmodels")
```
